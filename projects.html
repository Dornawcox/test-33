<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>OpenTEAM — Projects</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<header class="nav-shell" role="banner">
<button aria-controls="drawer" aria-expanded="false" class="menu-button" id="menuButton">
<span aria-hidden="true" class="menu-icon"><span></span></span>
<span class="menu-label">MENU</span>
</button>
<div class="nav-title">
<div class="nav-title-text">Open Technology Ecosystem for Agricultural Management</div>
</div>
<div aria-hidden="true" class="nav-logo">
<img alt="" src="assets/openteam_logo.svg"/>
</div>
</header>

<main class="page">
  <section class="hero hero--projects">
    <div class="container">
      <div class="hero__row">
        <div class="hero__text">
          <h1 class="hero__title">Projects</h1>
          <p class="hero__lede">Browse OpenTEAM working group projects and related resources. Use filters to find what you need.</p>
        </div>
        <a class="pill" href="index.html">Back to index ↗</a>
      </div>
    </div>
  </section>

  <div class="container">
    <div id="rails-root"></div>
  </div>
</main>

<footer class="footer">
<div class="container footer-grid">
<div class="footer-brand">
<img alt="OpenTEAM logo" class="footer-logo" src="assets/openteam_logo.svg"/>
<div>
<div class="footer-title">OpenTEAM</div>
<div class="footer-subtitle">Open Technology Ecosystem for Agricultural Management</div>
<div class="footer-meta">© <span id="year"></span> OpenTEAM — Built for Sharing</div>
</div>
</div>
<div class="footer-links">
<a href="#home">Home</a>
<a href="#initiatives">Our Work</a>
<a href="#pilots">Collabathons</a>
<a href="#convenings">Convenings</a>
<a href="#library">Library</a>
<a href="videos.html">Videos</a>
<a href="#reading">Inspirations</a>
<a href="#join">Join</a>
<a href="licenses.html">Licenses</a>
</div>
</div>
</footer>

<script>
// ==============================
// EDIT IN GITHUB
// 1) Show/hide rails: set show: true/false
// 2) Rail filter chips: edit filters array per rail
// 3) Turn search/filters on/off per rail: showSearch/showFilters
// 4) Reorder rails by reordering RAILS_CONFIG
// ==============================
const RAILS_CONFIG = [
  {
    "id": "openteam",
    "title": "All OpenTEAM Projects",
    "show": true,
    "showSearch": false,
    "showFilters": true,
    "filters": [
      "All types",
      "Data Trust Development",
      "Commons & Governance",
      "Data Sovereignty",
      "Regenerative Economics",
      "Interoperability",
      "Governance in Practice"
    ]
  },
  {
    "id": "metagov",
    "title": "Metagov Projects",
    "show": true,
    "showSearch": false,
    "showFilters": true,
    "showSort": true,
    "sortOptions": ["Last updated","Alphabetical"],
    "filters": [
      "All types"
    ]
  }
];

const OPENTEAM_PROJECTS = [
  {
    "title": "Fair Tech Registry Collabathon",
    "subtitle": "Co-design and collaboration activities supporting the FAIR Tech Registry.",
    "status": "Complete",
    "rawTheme": "Registry",
    "img": "assets/wg-project-card-fair-tech-registry-collabathon.jpg",
    "links": [
      {
        "label": "Project site ↗",
        "href": "https://openteamag.gitlab.io/codesign/fair-registry/"
      },
      {
        "label": "GitLab ↗",
        "href": "https://gitlab.com/OpenTEAMAg/codesign/fair-registry"
      }
    ],
    "type": "Data Trust Development"
  },
  {
    "title": "FAIR Tech Registry Documentation",
    "subtitle": "Developer-oriented documentation for the FAIR Tech Registry.",
    "status": "Active",
    "rawTheme": "Docs",
    "img": "assets/wg-project-card-fair-tech-registry-documentation.jpg",
    "links": [
      {
        "label": "Project site ↗",
        "href": "https://openteamag.gitlab.io/fair-tech-registry/devs/"
      },
      {
        "label": "GitLab ↗",
        "href": "https://gitlab.com/OpenTEAMAg/fair-tech-registry"
      }
    ],
    "type": "Data Trust Development"
  },
  {
    "title": "GLCDI Documentation",
    "subtitle": "Documentation hub for Grazing Lands Carbon Data Initiative.",
    "status": "Active",
    "rawTheme": "Carbon data",
    "img": "assets/wg-project-card-glcdi-documentation.jpg",
    "links": [
      {
        "label": "Project site ↗",
        "href": "https://openteamag.gitlab.io/codesign/grazingdata/"
      },
      {
        "label": "GitLab ↗",
        "href": "https://gitlab.com/OpenTEAMAg/codesign/grazingdata"
      }
    ],
    "type": "Interoperability"
  },
  {
    "title": "Agricultural Data Use Documents",
    "subtitle": "Ag data use agreements and related reference documents.",
    "status": "Active",
    "rawTheme": "Agreements",
    "img": "assets/wg-project-card-agricultural-data-use-documents.jpg",
    "links": [
      {
        "label": "Project site ↗",
        "href": "https://openteam-agreements.community/"
      },
      {
        "label": "GitLab ↗",
        "href": "https://gitlab.com/OpenTEAMAg/agreements"
      }
    ],
    "type": "Data Sovereignty"
  },
  {
    "title": "Code of Conduct",
    "subtitle": "Community expectations and participation guidelines.",
    "status": "Active",
    "rawTheme": "Governance",
    "img": "assets/wg-project-card-code-of-conduct.jpg",
    "links": [
      {
        "label": "Project site ↗",
        "href": "https://openteamag.gitlab.io/codesign/code-of-conduct/"
      },
      {
        "label": "GitLab ↗",
        "href": "https://gitlab.com/OpenTEAMAg/codesign/code-of-conduct"
      }
    ],
    "type": "Commons & Governance"
  },
  {
    "title": "Marketplace Working Group",
    "subtitle": "Working group charter, glossary, and shared framing for marketplace efforts.",
    "status": "Archive",
    "rawTheme": "Working group",
    "img": "assets/wg-project-card-marketplace-working-group.jpg",
    "links": [
      {
        "label": "Project site ↗",
        "href": "https://openteamag.gitlab.io/codesign/markets/"
      },
      {
        "label": "GitLab ↗",
        "href": "https://gitlab.com/OpenTEAMAg/codesign/markets"
      }
    ],
    "type": "Governance in Practice"
  },
  {
    "title": "PCSC farmOS Module",
    "subtitle": "Project space for a farmOS module and related implementation notes.",
    "status": "Archive",
    "rawTheme": "farmOS",
    "img": "assets/wg-project-card-pcsc-farmos-module.jpg",
    "links": [
      {
        "label": "Project site ↗",
        "href": "https://openteamag.gitlab.io/codesign/pcsc/"
      },
      {
        "label": "GitLab ↗",
        "href": "https://gitlab.com/OpenTEAMAg/codesign/pcsc"
      }
    ],
    "type": "Interoperability"
  },
  {
    "title": "Northeast Grazing and Soil Carbon Network",
    "subtitle": "Network hub for grazing and soil carbon collaboration materials.",
    "status": "Archive",
    "rawTheme": "Soil carbon",
    "img": "assets/wg-project-card-northeast-grazing-and-soil-carbon-network.jpg",
    "links": [
      {
        "label": "Project site ↗",
        "href": "https://openteamag.gitlab.io/codesign/grazing-SC-network/"
      },
      {
        "label": "GitLab ↗",
        "href": "https://gitlab.com/OpenTEAMAg/codesign/grazing-SC-network"
      }
    ],
    "type": "Regenerative Economics"
  },
  {
    "title": "Ag Data Wallet",
    "subtitle": "Project site for Agricultural Data Wallet materials and outcomes.",
    "status": "Archive",
    "rawTheme": "Data tools",
    "img": "assets/wg-project-card-ag-data-wallet.jpg",
    "links": [
      {
        "label": "Project site ↗",
        "href": "https://openteamag.gitlab.io/agricultural-data-wallet/"
      },
      {
        "label": "GitLab ↗",
        "href": "https://gitlab.com/OpenTEAMAg/ag-data-wallet"
      }
    ],
    "type": "Data Trust Development"
  },
  {
    "title": "OpenTEAM Convention",
    "subtitle": "Repository folder for OpenTEAM Convention materials.",
    "status": "Active",
    "rawTheme": "Governance",
    "img": "assets/wg-project-card-openteam-convention.jpg",
    "links": [
      {
        "label": "GitLab ↗",
        "href": "https://gitlab.com/OpenTEAMAg/ag-data-wallet/openteam-convention"
      }
    ],
    "type": "Commons & Governance"
  },
  {
    "title": "Documentation",
    "subtitle": "Top-level documentation repositories and related assets.",
    "status": "Active",
    "rawTheme": "Docs",
    "img": "assets/wg-project-card-documentation.jpg",
    "links": [
      {
        "label": "GitLab ↗",
        "href": "https://gitlab.com/OpenTEAMAg/documentation"
      }
    ],
    "type": "Data Trust Development"
  },
  {
    "title": "USDA Cooperative Agreements",
    "subtitle": "Folder for cooperative agreement materials and related project work.",
    "status": "Archive",
    "rawTheme": "Agreements",
    "img": "assets/wg-project-card-usda-cooperative-agreements.jpg",
    "links": [
      {
        "label": "GitLab ↗",
        "href": "https://gitlab.com/OpenTEAMAg/usda-cooperative-agreements"
      }
    ],
    "type": "Data Sovereignty"
  }
];
const METAGOV_PROJECTS = [
  {
    "title": "The Protopian Fiction Prize",
    "href": "https://metagov.org/projects/protopian",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Atlas Computing",
    "href": "https://metagov.org/projects/atlas-computing",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Attention Economy",
    "href": "https://metagov.org/projects/attention-economy",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Governable Spacemakers Fellowship",
    "href": "https://metagov.org/projects/governable-spacemakers-fellowship",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Theory + Practice",
    "href": "https://metagov.org/projects/theory-plus-practice",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Cryptoeconomic Systems",
    "href": "https://metagov.org/projects/cryptoeconomic-systems",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Interoperable Deliberative Tools",
    "href": "https://metagov.org/projects/interop",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Mathematics for Governance Design",
    "href": "https://metagov.org/projects/mathematics-for-governance-design",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "KOI Pond",
    "href": "https://metagov.org/projects/koi-pond",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Constitutions of Web3",
    "href": "https://metagov.org/projects/constitutions-of-web3",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Cryptopolitics",
    "href": "https://metagov.org/projects/cryptopolitics",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "D20 Governance",
    "href": "https://metagov.org/projects/d20-governance",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "DAO Science",
    "href": "https://metagov.org/projects/dao-science",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "DAOchem",
    "href": "https://metagov.org/projects/daochem",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Digital Ethnography Reading Group",
    "href": "https://metagov.org/projects/digital-ethnography-reading-group",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Governance Ecologies",
    "href": "https://metagov.org/projects/governance-ecologies",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Governance Experience Design",
    "href": "https://metagov.org/projects/governance-experience-design",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Governance Research Round",
    "href": "https://metagov.org/projects/governance-research-round",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Governance Surfaces",
    "href": "https://metagov.org/projects/governance-surfaces",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Grant Innovation Lab",
    "href": "https://metagov.org/projects/grant-innovation-lab",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Groundwork Fellowship",
    "href": "https://metagov.org/projects/groundwork-fellowship",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "LARP Governance",
    "href": "https://metagov.org/projects/larp-governance",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Modpol",
    "href": "https://metagov.org/projects/modpol",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Modular Politics",
    "href": "https://metagov.org/projects/modular-politics",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Redwood Parliament",
    "href": "https://metagov.org/projects/redwood-parliament",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Validator Commons",
    "href": "https://metagov.org/projects/validator-commons",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "CommunityRule",
    "href": "https://metagov.org/projects/communityrule",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Composing Games into Complex Institutions",
    "href": "https://metagov.org/projects/composing-games-into-complex-institutions",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "AI Renaissance",
    "href": "https://metagov.org/projects/ai-renaissance",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Calm Technology",
    "href": "https://metagov.org/projects/calm-technology",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Govbase Dataset",
    "href": "https://metagov.org/projects/govbase-dataset",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Govbase Labs",
    "href": "https://metagov.org/projects/govbase-labs",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Metagov Gateway",
    "href": "https://metagov.org/projects/metagov-gateway",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "MetagovDAO",
    "href": "https://metagov.org/projects/metagovdao",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Metagov Seminar",
    "href": "https://metagov.org/projects/metagov-seminar",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "OSS Transitions",
    "href": "https://metagov.org/projects/oss-transitions",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "PolicyKit",
    "href": "https://metagov.org/projects/policykit",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Public AI",
    "href": "https://metagov.org/projects/public-ai",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Telescope",
    "href": "https://metagov.org/projects/telescope",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "Agreement Engine",
    "href": "https://metagov.org/projects/agreement-engine",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  },
  {
    "title": "DAOstar",
    "href": "https://metagov.org/projects/daostar",
    "img": "https://www.google.com/s2/favicons?domain=metagov.org&sz=128",
    "desc": ""
  }
];

function el(tag, attrs={}, children=[]) {
  const n = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{ if(v===null || v===undefined) return; n.setAttribute(k,v); });
  children.forEach(c=>{ if(typeof c === "string") n.appendChild(document.createTextNode(c)); else if(c) n.appendChild(c); });
  return n;
}

function renderRail(cfg, items) {
  const section = el("section", {class:"rail-section", "data-rail":cfg.id});
  const header = el("div", {class:"rail-header"}, [
    el("h2", {class:"rail-title"}, [cfg.title]),
  ]);

  if(cfg.showSort){
    const sel = el("select", {class:"rail-sort", "data-scope":cfg.id, "aria-label":"Sort projects"});
    (cfg.sortOptions || ["Alphabetical"]).forEach((opt,i)=>{
      sel.appendChild(el("option", {value:opt, selected: i===0 ? "selected": null}, [opt]));
    });
    header.appendChild(sel);
  }

  section.appendChild(header);

  if(cfg.showSearch || cfg.showFilters) {
    const filterWrap = el("div", {class:"rail-filter", "data-scope":cfg.id});
    const row = el("div", {class:"filter-row"});
    if(cfg.showSearch) {
      row.appendChild(el("input", {
        class:"filter-search",
        "data-scope":cfg.id,
        type:"search",
        placeholder: cfg.id === "openteam" ? "Filter OpenTEAM projects…" : "Filter Metagov projects…",
        "aria-label": cfg.id === "openteam" ? "Filter OpenTEAM projects" : "Filter Metagov projects"
      }));
    }
    if(cfg.showFilters) {
      const chips = el("div", {class:"filter-chips", "data-scope":cfg.id});
      (cfg.filters || ["All types"]).forEach((f,i)=>{
        chips.appendChild(el("button", {
          class: "chip" + (i===0 ? " is-active" : ""),
          type:"button",
          "data-value": f
        }, [f]));
      });
      row.appendChild(chips);
    }
    filterWrap.appendChild(row);
    section.appendChild(filterWrap);
  }

  const rail = el("div", {class:"rail", "data-scope":cfg.id});
  items.forEach(item=>{
    rail.appendChild(renderCard(cfg.id, item));
  });
  section.appendChild(rail);
  return section;
}

function renderCard(scope, item) {
  if(scope === "openteam") {
    const a = el("a", {class:"pcard__link", href:(item.links?.[0]?.href || "#"), target:"_blank", rel:"noopener"});
    const card = el("article", {class:"pcard wg-project-card-lite", "data-theme": item.type || "All types"});
    const cover = el("div", {class:"pcard__cover"}, [
      el("img", {src:item.img || "assets/wg-project-card-placeholder.jpg", alt:"", loading:"lazy",
        onerror:"this.onerror=null;this.src='assets/wg-project-card-placeholder.jpg';"})
    ]);
    const meta = el("div", {class:"pcard__meta"}, [
      el("div", {class:"pcard__title"}, [item.title]),
      el("div", {class:"pcard__sub"}, [item.subtitle || ""]),
      el("div", {class:"pcard__pills"}, [
        item.status ? el("span", {class:"mini-pill"}, [item.status]) : null,
        item.type ? el("span", {class:"mini-pill mini-pill--theme"}, [item.type]) : null,
      ].filter(Boolean))
    ]);
    const actions = el("div", {class:"pcard__actions"}, [
      el("span", {class:"pcard__arrow","aria-hidden":"true"}, ["↗"])
    ]);
    a.appendChild(cover);
    a.appendChild(meta);
    a.appendChild(actions);
    card.appendChild(a);

    // expandable links
    if(item.links && item.links.length>1) {
      const more = el("details", {class:"pcard__more"}, [
        el("summary", {class:"pcard__morebtn"}, ["more"]),
        el("div", {class:"pcard__morebody"}, item.links.map(l =>
          el("a", {class:"pill secondary", href:l.href, target:"_blank", rel:"noopener"}, [l.label])
        ))
      ]);
      card.appendChild(more);
    }
    return card;
  }

  // metagov
  const card = el("article", {class:"pcard metagov-card", "data-theme":"All types"});
  const a = el("a", {class:"pcard__link", href:item.href, target:"_blank", rel:"noopener"});
  a.appendChild(el("div", {class:"pcard__cover pcard__cover--logo"}, [
    el("img", {src:item.img, alt:"", loading:"lazy"})
  ]));
  a.appendChild(el("div", {class:"pcard__meta"}, [
    el("div", {class:"pcard__title"}, [item.title]),
    el("div", {class:"pcard__sub"}, [item.desc || "metagov.org/projects"]),
  ]));
  a.appendChild(el("div", {class:"pcard__actions"}, [
    el("span", {class:"pcard__arrow","aria-hidden":"true"}, ["↗"])
  ]));
  card.appendChild(a);
  return card;
}


function sortItems(scope, items){
  const sel = document.querySelector(`.rail-sort[data-scope="${scope}"]`);
  const mode = sel ? sel.value : "Last updated";
  const arr = items.slice();
  if(mode === "Alphabetical"){
    arr.sort((a,b)=>(a.title||"").localeCompare(b.title||""));
  } else {
    // Last updated: keep original order as provided (closest to metagov default)
  }
  return arr;
}

function applyFilters(scope) {
  const q = (document.querySelector(`.filter-search[data-scope="${scope}"]`)?.value || "").toLowerCase().trim();
  const activeChip = document.querySelector(`.filter-chips[data-scope="${scope}"] .chip.is-active`);
  const active = activeChip ? activeChip.getAttribute("data-value") : "All types";

  const rail = document.querySelector(`.rail[data-scope="${scope}"]`);
  if(!rail) return;

  rail.querySelectorAll(".pcard").forEach(card=>{
    const theme = card.getAttribute("data-theme") || "All types";
    const txt = card.innerText.toLowerCase();
    const okQ = !q || txt.includes(q);
    const okT = (active === "All types") ? true : (theme === active);
    card.style.display = (okQ && okT) ? "" : "none";
  });
}

function mount() {
  const root = document.getElementById("rails-root");
  root.innerHTML = "";
  RAILS_CONFIG.forEach(cfg=>{
    if(!cfg.show) return;
    const rawItems = cfg.id === "openteam" ? OPENTEAM_PROJECTS : METAGOV_PROJECTS;
    const items = sortItems(cfg.id, rawItems);
    root.appendChild(renderRail(cfg, items));
  });
  // wire events
  document.addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip");
    if(!chip) return;
    const chipsWrap = chip.closest(".filter-chips");
    if(!chipsWrap) return;
    chipsWrap.querySelectorAll(".chip").forEach(c=>c.classList.remove("is-active"));
    chip.classList.add("is-active");
    applyFilters(chipsWrap.getAttribute("data-scope"));
  });
  document.addEventListener("change", (e)=>{
    const sel = e.target.closest(".rail-sort");
    if(sel){
      mount();
      return;
    }
  });

  document.addEventListener("input", (e)=>{
    const inp = e.target.closest(".filter-search");
    if(!inp) return;
    applyFilters(inp.getAttribute("data-scope"));
  });
  // initial
  applyFilters("openteam");
  applyFilters("metagov");
}


async function enrichMetagovCards(){
  const scope = "metagov";
  const rail = document.querySelector(`.rail[data-scope="${scope}"]`);
  if(!rail) return;

  const cacheKey = (href)=>`metagov_enrich_${href}`;
  const fromCache = (href)=>{
    try{ return JSON.parse(localStorage.getItem(cacheKey(href))||"null"); }catch(e){ return null; }
  };
  const toCache = (href, obj)=>{
    try{ localStorage.setItem(cacheKey(href), JSON.stringify(obj)); }catch(e){}
  };

  const cards = Array.from(rail.querySelectorAll(".metagov-card"));
  const jobs = cards.map(card=>{
    const a = card.querySelector(".pcard__link");
    const href = a ? a.getAttribute("href") : "";
    return {card, href};
  }).filter(j=>j.href && j.href.includes("metagov.org/projects/"));

  // simple concurrency limiter
  const limit = 6;
  let idx = 0;

  async function worker(){
    while(idx < jobs.length){
      const job = jobs[idx++];
      const {card, href} = job;
      const cached = fromCache(href);
      if(cached && (cached.img || cached.desc)){
        applyToCard(card, cached);
        continue;
      }
      try{
        const proxyUrl = `https://r.jina.ai/${href}`;
        const res = await fetch(proxyUrl);
        if(!res.ok) continue;
        const txt = await res.text();

        // image: first metagov media asset that looks like a hero image
        const imgMatch = txt.match(/https?:\/\/metagov\.org\/media\/pages\/projects\/[^\s"')]+?\.(?:jpg|jpeg|png|webp)/i);
        // description: try to capture line after 'DESCRIPTION'
        let desc = "";
        const descMatch = txt.match(/DESCRIPTION\s*\n+([^\n]+)\n/i);
        if(descMatch && descMatch[1]) desc = descMatch[1].trim();
        if(!desc){
          // fallback: look for '##### DESCRIPTION' pattern
          const alt = txt.match(/#####\s*DESCRIPTION\s*\n+([^\n]+)\n/i);
          if(alt && alt[1]) desc = alt[1].trim();
        }
        const payload = {
          img: imgMatch ? imgMatch[0] : "",
          desc
        };
        if(payload.img || payload.desc){
          toCache(href, payload);
          applyToCard(card, payload);
        }
      }catch(e){
        // ignore
      }
    }
  }

  function applyToCard(card, payload){
    if(payload.img){
      const imgEl = card.querySelector(".pcard__cover img");
      if(imgEl) imgEl.src = payload.img;
    }
    if(payload.desc){
      const sub = card.querySelector(".pcard__sub");
      if(sub) sub.textContent = payload.desc;
    }
  }

  const workers = Array.from({length: Math.min(limit, jobs.length)}, ()=>worker());
  await Promise.all(workers);
}

mount();
// hydrate metagov images + descriptions (cached in localStorage)
enrichMetagovCards();
</script>
</body>
</html>
